<!DOCTYPE html><html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles - CineStream</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="videos.js"></script>
</head>
<body>
    <section class="movie-detail-container">
        <div class="movie-backdrop" id="movie-backdrop"></div>
        <div class="movie-content">
            <button class="back-button" onclick="window.history.back()">‹ Volver</button>
            <div class="main-info">
                <div class="trailer-container featured-trailer">
                    <div class="trailer-wrapper">
                        <iframe class="movie-trailer" id="movie-trailer" allowfullscreen></iframe>
                    </div>
                </div>
                <div class="movie-info">
                    <h1 id="movie-title"></h1>
                    <div class="movie-meta">
                        <span id="movie-rating"></span>
                        <span id="movie-year"></span>
                        <span id="movie-duration"></span>
                    </div>
                    <p id="movie-synopsis"></p>
                    <div class="movie-actions">
                        <a id="playButton">
                            <button class="play-button">
                                <svg class="play-icon" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z" />
                                </svg>
                                Reproducir
                            </button>
                        </a>
                        <button class="add-list-button" id="mark-watched-detail">
                            <svg class="add-icon" viewBox="0 0 24 24">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg>
                            <span id="like-text">Me gusta</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section><script>
const apiKey = '995449ccaf6d840acc029f95c7d210dd';
let movie = null;

async function loadTrailers() {
    try {
        const response = await fetch('trailers.json');
        if (!response.ok) throw new Error('Error al cargar trailers.json');
        const data = await response.json();
        const trailers = {};
        Object.values(data).forEach(category => {
            category.forEach(movie => {
                trailers[movie.id] = movie.trailer;
            });
        });
        return trailers;
    } catch (error) {
        console.error('Error loading trailers:', error);
        return {};
    }
}

async function fetchMovieDetails(title) {
    try {
        const trailers = await loadTrailers();
        const searchResponse = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(title)}&language=es-MX`);
        const searchData = await searchResponse.json();
        if (searchData.results.length === 0) return null;
        
        const movieId = searchData.results[0].id;
        const detailsResponse = await fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${apiKey}&language=es-MX`);
        const details = await detailsResponse.json();
        
        let trailer = trailers[movieId] || "N/A";
        const videoUrl = getMovieVideoUrl(movieId);
        
        return {
            id: movieId,
            title: details.title,
            year: details.release_date?.split('-')[0] || 'N/A',
            rating: details.vote_average ? `${details.vote_average}/10` : 'N/A',
            duration: details.runtime ? `${Math.floor(details.runtime / 60)}h ${details.runtime % 60}m` : 'N/A',
            synopsis: details.overview || "Sin sinopsis disponible.",
            image: `https://image.tmdb.org/t/p/w500${details.poster_path}`,
            videoUrl: videoUrl,
            trailer: trailer
        };
    } catch (error) {
        console.error('Error obteniendo detalles de la película:', error);
        return null;
    }
}

function configurarEnlaceReproductor(movieData) {
    const videoUrl = movieData.videoUrl;
    if (videoUrl && videoUrl !== 'N/A') {
        document.getElementById("playButton").href = `Reproductor.html?video=${encodeURIComponent(videoUrl)}`;
    } else {
        document.getElementById("playButton").style.display = "none";
    }
}

function toggleLike() {
    if (!movie) return;
    const likedMovies = loadLikedMovies();
    const isLiked = likedMovies.some(m => m.id === movie.id);
    if (isLiked) {
        saveLikedMovies(likedMovies.filter(m => m.id !== movie.id));
        document.getElementById("like-text").innerText = "Me gusta";
    } else {
        likedMovies.push(movie);
        saveLikedMovies(likedMovies);
        document.getElementById("like-text").innerText = "No me gusta";
    }
}

function loadLikedMovies() {
    return JSON.parse(localStorage.getItem('likedMovies')) || [];
}
function saveLikedMovies(movies) {
    localStorage.setItem('likedMovies', JSON.stringify(movies));
}

document.getElementById("mark-watched-detail").addEventListener("click", toggleLike);

const urlParams = new URLSearchParams(window.location.search);
const movieTitle = urlParams.get('title');

if (movieTitle) {
    fetchMovieDetails(decodeURIComponent(movieTitle)).then(movieData => {
        if (movieData) {
            movie = movieData;
            document.getElementById("movie-title").innerText = movie.title;
            document.getElementById("movie-rating").innerText = movie.rating;
            document.getElementById("movie-year").innerText = movie.year;
            document.getElementById("movie-duration").innerText = movie.duration;
            document.getElementById("movie-trailer").src = `${movie.trailer}?autoplay=1&mute=1`;
            document.getElementById("movie-backdrop").style.backgroundImage = `url('${movie.image}')`;
            document.getElementById("movie-synopsis").innerText = movie.synopsis;
            configurarEnlaceReproductor(movieData);
        }
    });
}
</script>

</body>
</html>